| Type | Part    |
| ---- | ---     |
| 报销 | 日常,差旅|
# 报销模块更改
----
## 日常报销

### 1.更改流程
#### 1.1 更改父流程
日常报销:日常报销申请填写-->用户任务(打印报销单)-->用户任务(财务支付)-->结束
#### 1.2 更改子流程
  所有日常报销流程:快递费,办公费,房屋租金,水电,社保,培训,业务(有工作类型),汽油,租车,电话,加班,团建,招投标,交通补贴,在表单填写与下流程之间增加更新额度服务方法,  删除后面的财务支付以及更新额度,流程在修改打印状态后结束.


### 2.方法
#### 2.1 父流程  
  - 查询子流程的打印状态:  
  1.获取父流程实例ID ,根据父流程实例ID查询子流程实例ID,再根据子流程实例ID查询该子流程打印状态,所有子流程都可打印,父流程继续往下执行  

#### 2.2 任务状态字典
![image](../image/DailyCost/task_status.png "任务状态字典")


### 3.流程合并
#### 4.1 业务招待费
1. 流程统计
- 行政:
    `财务预审-->任务发布人-->直属上级-->部门总监-->总裁-->财务经理-->0`
- 公司级会议:
    `财务预审-->任务发布人-->直属上级-->部门总监-->总裁-->财务经理-->0`

- 销售:  
    `财务预审-->任务发布人-->直属上级-->销售中心副总裁-->财务经理-->0`

- 售前:
    `财务预审-->任务发布人-->直属上级-->方案中心总监-->销售中心副总裁-->财务经理-->0`
- 产品:  
    `财务预审-->任务发布人-->直属上级-->产品中心总监-->销售中心副总裁-->财务经理-->0`
- 交付:
    `财务预审-->任务发布人-->直属上级-->交付中心总监-->销售中心副总裁-->财务经理-->0`


2. 合并:
  - 主流程:
    `0-->判断并设置审批角色-->财务预审-->任务发布人-->直属上级-->(部门,销售,方案,产品,交付)总监审批-->(副,销售副)总裁-->财务经理-->修改打印状态-->1`

  任务发布人审批-->是否是直属上级-->总监审批    -->
                              -->直属上级审批 -->

    查看:/dynamicDrawForm/sqckForm?f=4d5b9f1d58bf483da197a8c1d170fa4e11
    填报:/dynamicDrawForm/sqtbForm?f=4d5b9f1d58bf483da197a8c1d170fa4e
    审批:/dynamicDrawForm/spForm?f=4d5b9f1d58bf483da197a8c1d170fa4e


3.
#### 4.2 其他费用
1. 流程统计
  - 快递费:
    `财务预审-->人事-->财务经理-->0`
  - 办公费:
    `财务预审-->人事-->财务经理-->0`
  - 水电费:
    `财务预审-->人事-->财务经理-->0`
  - 社保公积金:
    `财务预审-->人事-->财务经理-->0`
  - 培训费:  
    `财务预审-->人事-->财务经理-->0`

  - 房屋租金:
    `财务预审-->人事-->副总裁(营销?)-->财务经理-->0`

  - 汽油费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`
  - 租车费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`
  - 电话费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`
  - 加班餐费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`
  - 团建费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`
  - 交通补贴:
    `财务预审-->任务发布人-->直属上级-->部门总监-->主管副总裁-->财务经理-->0`

  - 招投标费:
    `财务预审-->任务发布人-->直属上级-->部门总监-->销售副总裁-->财务经理-->0`
2. 合并:

#### 4.3 服务方法
1. 获取`申请人id`
2. 获取申请人所有角色`id`
3. 获取`任务id`(对应任务发布表中的`流程实例id`)
4. 查询到`任务发布人id(creator__)`,及工作类型`(work_type) publisherId`
5. 查询任`务发布人`的所有角色`id publisherRoleIds`
6. 根据`任务发布人id`查询所在的`部门id`,再根据`部门id`查询部门类型
7. 判断申请人是否为(副)总裁 `Boolean creatorIsVpOrCEO`
8. 判断任务发布人是否为(副)总裁`Boolean publisherIsVpOrCEO`
9. 获取申请人的直属上级 `leaderRoleId`
10. 判断任务发布人是否为申请人直属上级`Boolean publisherIsLeader`
11. 公司级会议与行政相同
12. 如果`任务发布人`的`部门类型`与`任务工作类型`相同
    - 0-->任务发布人所属部门领导审批
    - 1-->申请人所属部门领导审批

13. 网关
  - 发布人是不是直属上级
  - 申请人是(副)总裁

  - 发布人上级有一个
  - 发布人上级有两个

---



## 差旅报销
### 1.更改流程

## 我的报销
### 1.方法
#### 1.1 公用方法  
更改支付状态,参数 `execution`,`tableName`

#### 1.2父流程更改  
在父流程财务支付后添加服务方法(更新支付状态),更新父流程的支付状态.

### 2.页面
#### 2.1 进行中查询
- 根据报销类型查询所有父流程支付状态为未完成的 显示到页面
- 点击查看显示所有子流程信息(事项,申请编号,申请时间,步骤,操作(查看--跳转到详情页面))  

#### 2.2 已完成查询
- 根据报销类型查询所有父流程支付状态为已完成的 显示到页面
- 点击查看显示所有子流程信息(事项申请编号,申请时间,步骤,操作(查看--跳转到详情页面))
